# Краткий конспект лекций по продуктивному программированию на КТ ИТМО (y2019)
## Code Review (лекция 3)
**Changed List** - набор изменений переводящихся из состояния разработки в стабильное состояние. Синоним pull request-а

Code review - одна из преград на CL в стабильное состояние. Или немного преземленнее: одна из преград на пути pull request-а к слитию в основную ветку.

![image](https://user-images.githubusercontent.com/57497898/210035931-2770e4e5-081f-4584-8fe7-1fcac7caad60.png)

По-хорошему, code review должен быть последним этапом защиты кодовой базы от плохого кода (после unit тестов, проверок на кодстайл и тд), так как
1. занимает время другого разработчика
2. именно человек должен принять финальное решение по слитию кода, а не unit тесты или что-то еще проверяемое программами

---
Есть большая разница между **Code Quality (Качество кода)** и **Code Style (Стиль кода)**

Code Quality - это то насколько код хорош, во всевозможных смыслах

Code Style ~ четкие правила для синтаксиса языка (напр сколько аргументов у функции может быть максимум, использовать ли camelCase или snake_case в названиях переменных). Чаще различается у разных компаний.

Табличка различий Code Quality и Code Style
![image](https://user-images.githubusercontent.com/57497898/210037453-1dbd156a-d797-4320-96b2-8ce046596c87.png)

---
Зачем нужен Code Review?

1. Качество кода влечет качество продукта. Во первых это дешевый способ отловить потенциальные баги, во вторых это хорошая инвестиция в будущее качество проекта.
2. Feedback loop -> профессиональный рост
3. Reviewer в свою очередь может узнавать что-то новое из проверяемого кода

Золотые правила Code Review
1. Если PR улучшает кодовую базу, то этого достаточно чтобы его принять
2. Правила Review кода это хорошо, но если продукт требует срочных критических правок, то ими можно пренебречь 

На что обращать внимание при Code Review
1. Какой смысл у этого PR? (Должен ли он вообще быть?)
2. Делает ли он то что нужно?
3. Можно ли потом будет эти изменения исправить? (откатить, изменить)

Сложность изменения/отката PR расчитывается через формулу:

- $SE = \int P\ dt\ dh$

*Software Engeneering = интеграл программирования по времени и по людям*

----
### На что обратить внимание при проверке PR?
#### 1. Должен ли PR существовать?
- критерий: хорошее описание. Описание к PR не должно быть сильно кратким, типа "fix bug". Так же не надо сразу вдаваться в детали, сначала напишите summary
- PR должен делать одну конкретную вещь, исключая рефакторинги
- PR должен быть небольшого размера
- автор PR должен иметь права делать такие изменения

#### 2. Проверка кода на функцональность
- в команде есть договоренность что нужно сделать этот код (например документ или обсуждение на созвоне)
- выполняет ли код свои функции
  - функционал покрыт тестами
  - правильно ли написаны бд транзакции
  - правильно ли работает параллельный код
- ревьюер - последняя стадия защиты

#### 3. Сложность и структура классов
- ООП должно удовлетворять паттерну SOLID - это очень облегчает понимание кода
- не пропускайте неоправданно сложные конструкции (строчка слишком сложная, функция слишком сложная, класс слишком сложный)
- вы можете упростить что-то в PR. Например вынести общий код в отдельный метод, чтобы упростить как и свой новый код, так и старый

Не будьте злыми, не надо усложнять код. Людям которые считают свой сложный код достаточно легким, напоминайте что их код будут поддерживать другие люди. Да и сам автор через 6 месяцев не вспомнит контекст и будет долго разбираться в своем же коде.

Еще один случай: люди усложняют код, чтобы он работал быстрее
- просите автора доказать что код ускорит свое выполнение
- нужно ли это ускорение? Например: пусть у нас в 2 раза ускорится выполнение логики программы, но 99% времени все еще будет занимать запрос к базе, тогда это усложнение кода не нужно

Правило по которому по которому можно заниматься сложными оптимизациями: 
- сначала мы пишем код, до состояния когда он работает корректно
- затем оптимизируем узкие места (bottlenecks) если нужно

![image](https://user-images.githubusercontent.com/57497898/212164722-fb7376f5-0ca2-4909-a879-8e6289c73551.png)

Как писать сложный код?
- максимально инкапсулируем его и создаем простое апи, чтобы разработчик мог не долго задумываться и использовать ваше решение как черный ящик
- максимально протестируйте ваш сложный функционал

#### 4. API
Апи всегда сложно изменить потом: им будет пользоваться много кто, поэтому недостаточно просто поменть api, нужно еще подправить все места где оно используется.

Сложность изменения API: Class API < Interface API < Service API < External Service API

#### 5. Тесты 
Про тесты подробнее в следующих лекциях, но пока основное:
- тесты должны быть!
- у тестов по-другому проверяется code quality
- каждый тест должен быть:
  - корректным
  - коротким
  - полным
  - быстрыми

#### 6. Документация
Лучше иметь плохую документацию, чем не иметь документацию совсем или уметь устаревшую докумнтацию

#### 7. Naming
Кто-то считает что это самая сложная часть в программировании

Основные задачи:
- название должно полностью отражать что это такое или что оно делает
- название не должно быть длинным

Основная проблема: длина имени vs понятность

#### 8. Комментарии 
- комментарии это хорошо
- должны отвечать на вопрос "почему?"

#### 9. Особенности языка и используемых фреймворков
 
----

### Как проверять PR?

#### 1. Начать с ознакомления с PR
1. Прочитать описание PR-а
2. Сначала проверить основные изменения
3. Затем проверить все остальное

#### 2. Проверяем каждую строчку
- исключение: автосгенерированный код не всегда надо проверять
- если после слития PR код меняется (postprocessing) то это плохо

#### 3. Проверять PR лучше в течение бизнес дня
- code review в приоритете, чтобы не тормозить других разработчиков
- если не можешь проверить сразу, лучше сказать об этом автору, чтобы он нашел другого проверяющего, если это нужно
- убедитесь, что вы в курсе всех ревью которые висят на вас

#### 4. Стремитись к тому чтобы дать approve быстро
- если больших проблем нет, то напишите в комментарии о маленьких проблемах и сразу кидайте approve

#### 5. Помечайте некритические недочеты
- не очень хорошо, если автор отнесется к необяательному исправлению очень серьезно
- а лучше помечайте степень важности недочетов в префиксе комментария, например:
![image](https://user-images.githubusercontent.com/57497898/212178178-9da3fd73-e071-44ca-9601-0c0722e69264.png)

#### 6. Не надо быть придирчивым
- идевльных PR не существует
- если код более-менее на уровне того что уже существует то все ок
- ограничивайте колличество комментариев с неважными правками

#### 7. Цитирование авторитетных источников
- убеждает автора в объективновсти вашего мнения
- дает автору возможность улучшить свои знания о проблеме

#### 8. Нужно исходить из того что программист написал код так не злонамеренно и не по глупости
- нужно понимать что (уточнение от меня: *часто*) вы работаете вы работаете с добрыми и компетентными людьми, и зачастую за любым решением стоит первопричина
- если проблема все-таки есть то автор
  - сделал её по невнимательности, что бывает у всех
  - не знал, так как никто не учил его этому и его опыт отличается от вашего

#### 9. Делайте гайд человеку
- в вашу задачу не входит написание кода за человека, давайте ему гайд (уточнение от меня: это очень важный пункт, надо говорить что, а не как)
- хорошая идея приложить пример кода к вашему комментарию

#### 10. Давайте позитивные комментарии
- делает колег более радостными
- они побуждают делать человека код лучше

----

### Как проверяющему разрешать конфликты с автором
1. постарайтесь прийти к консенсусу
2. можете попробовать поговорить вживую или созвониться
3. если речь идет о серьезных вещах, то будьте настойчивы
4. если вы не можете прийти к общему решению, можете позвать третьего коллегу чтобы он вас рассудил
5. если не очень понятно как правильно сделать, то соблюдайте стиль существующего кода
6. если автор говорит что он исправит что-то потом, не верьте
7. используйте свои "сражения" за правильный код мудро (иначе вас не будут в последствии слушать)

